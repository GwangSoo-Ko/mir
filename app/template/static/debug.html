<!DOCTYPE html>
<html>
<head>
    <title>웹푸시 디버깅</title>
</head>
<body>
    <h1>웹푸시 디버깅</h1>
    <div id="status"></div>
    <button onclick="checkStatus()">1.상태 확인</button>
    <button onclick="testPush()">2.푸시 테스트</button>
    <button onclick="requestPermission()">3.알림 권한 요청</button>
    <button onclick="resubscribe()">4.재구독</button>

    <script>
        const statusDiv = document.getElementById('status');
        
        function log(message) {
            console.log(message);
            statusDiv.innerHTML += '<p>' + message + '</p>';
        }

        async function checkStatus() {
            statusDiv.innerHTML = '<h3>상태 확인 중...</h3>';
            
            // 1. 알림 권한 확인
            log(`알림 권한: ${Notification.permission}`);
            
            // 2. 서비스 워커 지원 확인
            log(`서비스 워커 지원: ${'serviceWorker' in navigator}`);
            log(`푸시 매니저 지원: ${'PushManager' in window}`);
            
            // 3. 서비스 워커 등록 상태
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    log(`서비스 워커 등록됨: ${registration.scope}`);
                    log(`서비스 워커 상태: ${registration.active ? '활성' : '비활성'}`);
                    
                    // 4. 현재 구독 상태
                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        log(`구독 상태: 활성`);
                        log(`엔드포인트: ${subscription.endpoint}`);
                    } else {
                        log(`구독 상태: 비활성`);
                    }
                } else {
                    log(`서비스 워커: 등록되지 않음`);
                }
            } catch (error) {
                log(`서비스 워커 확인 오류: ${error.message}`);
            }
            
            // 5. 서버 디버그 정보
            try {
                const response = await fetch('/debug');
                const data = await response.json();
                log(`서버 구독 수: ${data.subscriptions_count}`);
                log(`VAPID 키 존재: ${data.vapid_private_key_exists}`);
            } catch (error) {
                log(`서버 디버그 정보 오류: ${error.message}`);
            }
        }

        async function testPush() {
            try {
                log('푸시 테스트 중...');
                const response = await fetch('/test_simple');
                const result = await response.json();
                log(`푸시 테스트 결과: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`푸시 테스트 오류: ${error.message}`);
            }
        }

        async function requestPermission() {
            try {
                const permission = await Notification.requestPermission();
                log(`알림 권한 요청 결과: ${permission}`);
                
                if (permission === 'granted') {
                    // 테스트 알림 표시
                    new Notification('테스트 알림', {
                        body: '브라우저 알림이 정상 작동합니다!'
                    });
                }
            } catch (error) {
                log(`권한 요청 오류: ${error.message}`);
            }
        }

        async function resubscribe() {
            try {
                log('1.재구독 시작...');
                
                // 기존 서비스 워커 등록 해제
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    log('2.기존 서비스 워커 해제됨');
                }
                
                // 새로 등록
                const registration = await navigator.serviceWorker.register('/zsw.js', {
                                                scope: '/'
                                                });
                log('3.서비스 워커 재등록됨');
                
                await navigator.serviceWorker.ready;
                log('4.서비스 워커 준비됨');
                
                // VAPID 키 가져오기
                const response = await fetch('/vapid_public_key');
                const { vapidPublicKey } = await response.json();
                log('5.vapid_public_key get');
                
                // 구독
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });
                
                log('6.푸시 구독 성공');
                
                // 서버에 전송
                const subscribeResponse = await fetch('/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'super',
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
                            auth: arrayBufferToBase64(subscription.getKey('auth'))
                        }
                    })
                });
                log('7.subscribe 요청');
                
                const result = await subscribeResponse.json();
                log(`8.서버 구독 결과: ${JSON.stringify(result)}`);
                
            } catch (error) {
                log(`999...재구독 오류: ${error.message}`);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
            const raw = atob(base64);
            return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
        }

        function arrayBufferToBase64(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
        }

        // 페이지 로드 시 자동 상태 확인
        window.onload = checkStatus;
    </script>
</body>
</html>